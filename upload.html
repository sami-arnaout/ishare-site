<!doctype html><meta charset="utf-8">
<title>iSharePhotos – Upload (Pilot)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<body style="font-family:system-ui;padding:24px;max-width:800px;margin:auto">
  <h1>Upload (Pilot)</h1>
  <p>JPEG/HEIC only. Photo must include GPS in EXIF or it will be rejected.</p>
  <input id="file" type="file" accept="image/jpeg,image/heic,image/heif">
  <button id="go">Upload</button>
  <pre id="out" style="white-space:pre-wrap;background:#f5f7fb;padding:12px;border-radius:8px"></pre>

  <!-- Supabase client -->
  <script src="https://esm.sh/@supabase/supabase-js@2"></script>
  <!-- EXIF & HEIC helpers -->
  <script src="https://unpkg.com/exifr/dist/exifr.umd.js"></script>
  <script src="https://unpkg.com/heic2any/dist/heic2any.min.js"></script>

  <script>
    // TODO: replace with your values from Supabase → Settings → API
    const SUPABASE_URL  = "https://mctkvmwaflsnohpjfmta.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jdGt2bXdhZmxzbm9ocGpmbXRhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMTk5MTEsImV4cCI6MjA3MjU5NTkxMX0.6vUzyxbE8K4z6GH-_n5R7FUnWaD6Yha9eP45YZ0Ih28";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    const $ = id => document.getElementById(id);
    const log = (...a) => $('out').textContent += a.join(' ') + '\n';

    async function readExif(file){
      const [gps, meta] = await Promise.all([ exifr.gps(file), exifr.parse(file, ['DateTimeOriginal','Make','Model']) ]);
      if (!gps || typeof gps.latitude !== 'number' || typeof gps.longitude !== 'number') {
        throw new Error('No GPS found in EXIF');
      }
      const when = meta?.DateTimeOriginal ? new Date(meta.DateTimeOriginal) : new Date(file.lastModified);
      return { lat:gps.latitude, lon:gps.longitude, takenAt:when, make:meta?.Make, model:meta?.Model };
    }
    async function toJpegIfHeic(file){
      const name = (file.name || '').toLowerCase();
      if (name.endsWith('.heic') || name.endsWith('.heif') || /heic|heif/i.test(file.type)) {
        const out = await heic2any({ blob:file, toType:'image/jpeg', quality:0.9 });
        return new File([out], (file.name||'photo').replace(/\.(heic|heif)$/i,'.jpg'), { type:'image/jpeg' });
      }
      return file;
    }
    async function makeThumb(jpeg){
      const img = new Image(), url = URL.createObjectURL(jpeg);
      await new Promise((ok,err)=>{ img.onload=ok; img.onerror=err; img.src=url; });
      const max = 1280, s = Math.min(1, max/Math.max(img.width,img.height));
      const c = document.createElement('canvas'); c.width = img.width*s; c.height = img.height*s;
      c.getContext('2d').drawImage(img,0,0,c.width,c.height);
      const blob = await new Promise(res => c.toBlob(res,'image/jpeg',0.82));
      URL.revokeObjectURL(url);
      return new File([blob], 'thumb.jpg', {type:'image/jpeg'});
    }
    function iso(d){ return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString(); }

    $('go').onclick = async () => {
      $('out').textContent = '';
      const file = $('file').files[0];
      if (!file) { log('Pick a file first.'); return; }
      try {
        log('Reading EXIF...');
        const exif = await readExif(file);
        log('GPS:', exif.lat.toFixed(6), exif.lon.toFixed(6), 'Time:', exif.takenAt.toISOString());

        log('Converting to JPEG if needed...');
        const jpeg = await toJpegIfHeic(file);

        log('Creating thumbnail...');
        const thumb = await makeThumb(jpeg);

        const stamp = Date.now();
        const origPath  = `orig/${stamp}-${(jpeg.name||'photo.jpg').replace(/[^a-z0-9_.-]/gi,'_')}`;
        const thumbPath = `thumb/${stamp}-thumb.jpg`;

        log('Uploading original...');
        let { error: e1 } = await sb.storage.from('photos-original').upload(origPath, jpeg, { contentType:'image/jpeg' });
        if (e1) throw e1;

        log('Uploading thumbnail...');
        let { error: e2 } = await sb.storage.from('photos-thumb').upload(thumbPath, thumb, { contentType:'image/jpeg' });
        if (e2) throw e2;

        log('Saving metadata...');
        const row = {
          user_id: null,
          lat: exif.lat, lon: exif.lon,
          taken_at: iso(exif.takenAt),
          storage_path: origPath,
          thumb_path: thumbPath,
          device_make: exif.make || null,
          device_model: exif.model || null
        };
        const { error: e3 } = await sb.from('photos').insert(row);
        if (e3) throw e3;

        log('✅ Done. Photo saved & searchable.');
      } catch (err) {
        log('❌', err.message || String(err));
      }
    };
  </script>
</body>
